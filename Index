import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  onAuthStateChanged, 
  signOut,
  signInAnonymously,
  signInWithCustomToken,
} from 'firebase/auth';
import { 
  getFirestore, 
  doc, 
  getDoc, 
  setDoc, 
  collection, 
  addDoc, 
  onSnapshot, 
  serverTimestamp, 
  updateDoc 
} from 'firebase/firestore';
import { 
  CreditCard, 
  CheckCircle, 
  Lock, 
  Zap, 
  ShieldCheck, 
  ArrowRight, 
  Star,
  Activity,
  User as UserIcon,
  LogOut,
  ChevronRight
} from 'lucide-react';

// --- Configuraci√≥n de Firebase ---
const firebaseConfig = JSON.parse(__firebase_config);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- L√≥gica de Generaci√≥n de Casos (Narrativa Avanzada) ---
const getRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];
const getRandomAge = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const getRandomGender = () => Math.random() > 0.5 ? { g: "Un hombre", p: "El paciente", s: "masculino" } : { g: "Una mujer", p: "La paciente", s: "femenino" };

const introPhrasesAdult = [
  (g, s, a) => `Acude a tu consulta ${s === 'masculino' ? 'un paciente' : 'una paciente'} de ${a} a√±os...`,
  (g, s, a) => `Llega al servicio de urgencias ${g.toLowerCase()} de ${a} a√±os...`,
  (g, s, a) => `Se valora ${s === 'masculino' ? 'a un paciente' : 'a una paciente'} de ${a} a√±os en medicina interna...`,
  (g, s, a) => `Se solicita tu valoraci√≥n para ${s === 'masculino' ? 'un paciente' : 'una paciente'} de ${a} a√±os...`
];

const scaleData = {
  glasgow: { 
    name: "Escala de Glasgow", 
    key: "glasgow", 
    generateCase: () => {
      const e = getRandom([{ s: 4, n: "ojos abiertos espont√°neamente" }, { s: 3, n: "abre los ojos al llamado" }, { s: 2, n: "abre los ojos al dolor" }, { s: 1, n: "sin apertura ocular" }]);
      const v = getRandom([{ s: 5, n: "orientado" }, { s: 4, n: "confuso" }, { s: 2, n: "sonidos incomprensibles" }]);
      const m = getRandom([{ s: 6, n: "obedece √≥rdenes" }, { s: 4, n: "retirada al dolor" }, { s: 1, n: "fl√°cido" }]);
      const total = e.s + v.s + m.s;
      const { g, s } = getRandomGender();
      const intro = getRandom(introPhrasesAdult)(g, s, getRandomAge(18, 80));
      return { 
        description: `${intro} Tras sufrir un traumatismo, presenta ${e.n}, se encuentra ${v.n} y muestra ${m.n} en las extremidades.`, 
        options: generateOptions(total, 3, 15), 
        correctAnswer: total 
      };
    }
  },
  apgar: { name: "Puntuaci√≥n de Apgar", key: "apgar", generateCase: () => ({ description: "Reci√©n nacido a los 5 minutos: cuerpo rosado con extremidades azules, FC de 110 lpm, llanto vigoroso, gesticulaci√≥n activa y buena flexi√≥n.", options: [7, 8, 9, 10], correctAnswer: 9 })},
  silverman: { name: "Escala de Silverman", key: "silverman", generateCase: () => ({ description: "Neonato con aleteo nasal marcado, quejido audible sin estetoscopio, tiraje intercostal evidente y disociaci√≥n toraco-abdominal.", options: [3, 5, 7, 8], correctAnswer: 7 })},
  alvarado: { name: "Escala de Alvarado", key: "alvarado", generateCase: () => ({ description: "Paciente con dolor que inici√≥ en epigastrio y migr√≥ a FID, anorexia, n√°useas, fiebre de 38¬∞C y Blumberg positivo.", options: [5, 6, 7, 8], correctAnswer: 6 })},
  wells: { name: "Criterios de Wells", key: "wells", generateCase: () => ({ description: "Paciente con antecedente de c√°ncer activo, edema de toda la pierna izquierda y dolor a la palpaci√≥n venosa profunda.", options: [1, 2, 3, 4], correctAnswer: 3 })},
  curb65: { name: "Escala CURB-65", key: "curb65", generateCase: () => ({ description: "Paciente de 75 a√±os, desorientado, FR de 32 rpm, PA de 85/55 mmHg y Urea de 50 mg/dL.", options: [2, 3, 4, 5], correctAnswer: 5 })},
  wagner: { 
    name: "Escala de Wagner", 
    key: "wagner", 
    generateCase: () => {
      const grades = [
          { s: 0, n: "pie en riesgo, callosidades gruesas pero sin soluci√≥n de continuidad en la piel." },
          { s: 1, n: "√∫lcera superficial que afecta dermis pero no tejido celular subcut√°neo." },
          { s: 2, n: "√∫lcera profunda que penetra hasta c√°psula articular y tendones sin absceso." },
          { s: 3, n: "√∫lcera profunda con secreci√≥n purulenta y signos de osteomielitis." },
          { s: 4, n: "gangrena localizada en el tal√≥n." },
          { s: 5, n: "gangrena extensa que afecta todo el antepi√©." }
      ];
      const item = getRandom(grades);
      const { g, s } = getRandomGender();
      const age = getRandomAge(50, 75);
      const intro = getRandom(introPhrasesAdult)(g, s, age);
      return { 
        description: `${intro} Diab√©tico cr√≥nico. A la inspecci√≥n del pie derecho presenta ${item.n}`, 
        options: [0, 1, 2, 3, 4, 5].sort(() => Math.random() - 0.5).slice(0, 4), 
        correctAnswer: item.s 
      };
    }
  }
};

function generateOptions(correctAnswer, min, max) {
  let options = new Set([correctAnswer]);
  while (options.size < 4) {
    const randomOption = Math.floor(Math.random() * (max - min + 1)) + min;
    options.add(randomOption);
  }
  return Array.from(options).sort((a,b) => a - b);
}

// --- Componentes UI ---

const Spinner = () => (
  <div className="flex justify-center items-center py-10">
    <div className="animate-spin h-10 w-10 border-4 border-copper-500 border-t-transparent rounded-full"></div>
  </div>
);

const Header = ({ onNavigate, currentUser, onLogout }) => {
  const isLoggedIn = currentUser && currentUser.profile && currentUser.profile.name;
  const isSubscribed = currentUser?.profile?.subscriptionStatus === 'active';

  return (
    <nav className="bg-gray-900 border-b border-gray-800 fixed w-full z-50 top-0 shadow-lg h-16 flex items-center">
      <div className="max-w-7xl mx-auto px-4 w-full flex justify-between items-center">
        <div 
          className="flex items-center space-x-3 cursor-pointer group" 
          onClick={() => onNavigate('home')}
        >
          <div className="w-10 h-10 bg-gray-800 border-2 border-copper-500 rounded-xl flex items-center justify-center font-black text-copper-500 shadow-lg shadow-copper-500/10 group-hover:scale-105 transition-transform">M</div>
          <span className="text-xl font-black text-white tracking-tighter">Medi<span className="text-copper-500">Scales</span></span>
        </div>
        
        <div className="flex items-center space-x-6">
          {isLoggedIn ? (
            <>
              {isSubscribed && (
                <span className="hidden md:flex items-center space-x-1 bg-copper-500/10 text-copper-500 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border border-copper-500/30">
                  <Star size={10} fill="currentColor" /> <span>Premium</span>
                </span>
              )}
              <button onClick={() => onNavigate('dashboard')} className="text-gray-400 hover:text-copper-500 transition font-bold text-xs uppercase tracking-widest">Escalas</button>
              <button onClick={() => onNavigate('profile')} className="text-gray-400 hover:text-copper-500 transition">
                <UserIcon size={20} />
              </button>
              <button onClick={onLogout} className="text-red-500 hover:text-red-400 transition">
                <LogOut size={20} />
              </button>
            </>
          ) : (
            <button 
              onClick={() => onNavigate('profile_setup')} 
              className="bg-copper-600 border-2 border-copper-500 text-white hover:bg-copper-500 px-6 py-2 rounded-xl font-black text-xs uppercase tracking-widest transition shadow-xl shadow-copper-900/20"
            >
              Comenzar
            </button>
          )}
        </div>
      </div>
    </nav>
  );
};

// --- P√°ginas ---

const HomePage = ({ onNavigate }) => (
    <div className="pt-24 px-6 max-w-5xl mx-auto text-center animate-in pb-20">
      <div className="inline-block p-4 border-2 border-copper-500 rounded-3xl mb-8 bg-copper-500/10 shadow-lg shadow-copper-500/5">
        <Activity className="text-copper-500" size={40} />
      </div>
      <h1 className="text-6xl md:text-8xl font-black text-white mb-8 leading-none tracking-tighter">
        Decisiones M√©dicas <br/><span className="text-copper-500">Sin Errores.</span>
      </h1>
      <p className="text-gray-400 text-xl md:text-2xl mb-12 font-medium max-w-3xl mx-auto leading-relaxed">
        Entrena tu ojo cl√≠nico con nuestro simulador avanzado de escalas internacionales. Dise√±ado para estudiantes, residentes y especialistas.
      </p>
      <div className="flex flex-col md:flex-row items-center justify-center gap-6">
        <button 
          onClick={() => onNavigate('dashboard')} 
          className="w-full md:w-auto bg-copper-600 border-2 border-copper-500 px-12 py-5 rounded-2xl font-black text-xl text-white hover:bg-copper-500 transition shadow-2xl shadow-copper-900/40 flex items-center justify-center gap-3 group"
        >
          Entrar al Simulador <ChevronRight className="group-hover:translate-x-1 transition-transform" />
        </button>
      </div>
    </div>
);

const SubscriptionPage = ({ onSubscribe, currentUser }) => {
  const [loading, setLoading] = useState(false);
  
  const handlePayment = async () => {
    setLoading(true);
    setTimeout(async () => {
      await onSubscribe();
      setLoading(false);
    }, 1800);
  };

  return (
    <div className="pt-24 px-6 pb-20 animate-in">
      <div className="max-w-5xl mx-auto grid md:grid-cols-2 gap-16 items-center">
        <div>
          <h2 className="text-5xl font-black text-white mb-8 leading-tight tracking-tight">Sube de nivel <br/><span className="text-copper-500">con Premium</span></h2>
          <div className="space-y-5 mb-10">
            {[
              "Acceso ilimitado a las 7 escalas",
              "Casos cl√≠nicos narrativos inteligentes",
              "Historial de desempe√±o y estad√≠sticas",
              "Soporte de gu√≠as cl√≠nicas 2026",
              "Sin interrupciones ni l√≠mites"
            ].map((t, i) => (
              <div key={i} className="flex items-center gap-4 text-gray-300 font-bold text-lg">
                <CheckCircle className="text-copper-500 flex-shrink-0" size={24} />
                <span>{t}</span>
              </div>
            ))}
          </div>
        </div>

        <div className="bg-gray-800 border-2 border-copper-500 p-10 rounded-[3rem] shadow-2xl relative overflow-hidden">
          <div className="absolute top-0 right-0 bg-copper-600 border-l-2 border-b-2 border-copper-500 text-white px-6 py-2 font-black text-[10px] uppercase tracking-widest rounded-bl-3xl">Pase Total</div>
          <div className="mb-10">
            <span className="text-gray-500 text-xs font-black uppercase tracking-widest">Suscripci√≥n Mensual</span>
            <div className="flex items-baseline gap-2 mt-2">
              <span className="text-6xl font-black text-white">$99</span>
              <span className="text-gray-400 font-bold text-xl uppercase tracking-widest">MXN</span>
            </div>
          </div>

          <div className="space-y-6 mb-12">
            <div className="flex flex-col gap-4">
              <label className="text-[10px] font-black text-gray-500 uppercase tracking-widest">M√©todo de Pago</label>
              <div className="relative group">
                <CreditCard className="absolute left-5 top-1/2 -translate-y-1/2 text-copper-500 group-focus-within:text-white transition" size={20} />
                <input 
                    type="text" 
                    placeholder="N√∫mero de Tarjeta" 
                    className="w-full bg-gray-900 border-2 border-gray-700 focus:border-copper-500 rounded-2xl py-5 pl-14 pr-6 text-white font-bold outline-none transition"
                />
              </div>
            </div>
          </div>

          <button 
            onClick={handlePayment} 
            disabled={loading} 
            className="w-full bg-copper-600 border-2 border-copper-500 hover:bg-copper-500 py-6 rounded-[2rem] font-black text-lg transition shadow-xl shadow-copper-900/30 flex items-center justify-center gap-3 text-white uppercase tracking-widest"
          >
            {loading ? <div className="animate-spin h-6 w-6 border-4 border-white border-t-transparent rounded-full"></div> : <>Activar Suscripci√≥n <ShieldCheck /></>}
          </button>
          <p className="text-center text-[10px] text-gray-600 mt-6 font-bold uppercase tracking-widest">Transacci√≥n Cifrada 256-bit</p>
        </div>
      </div>
    </div>
  );
};

// --- App Principal ---

const App = () => {
  const [currentPage, setCurrentPage] = useState('home');
  const [currentUser, setCurrentUser] = useState(null);
  const [scores, setScores] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isAuthReady, setIsAuthReady] = useState(false);
  
  const [practiceSettings, setPracticeSettings] = useState(null);
  const [lastResults, setLastResults] = useState(null);
  const isLoggingOut = useRef(false);
  const scoresUnsubscribe = useRef(null);

  useEffect(() => {
    const unsubAuth = onAuthStateChanged(auth, async (user) => {
      if (scoresUnsubscribe.current) { scoresUnsubscribe.current(); scoresUnsubscribe.current = null; }
      if (isLoggingOut.current) { setIsAuthReady(true); setLoading(false); return; }

      if (user) {
        const uid = user.uid;
        const profileDocRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'details');
        const scoresColRef = collection(db, 'artifacts', appId, 'users', uid, 'scores');

        try {
          const profileSnap = await getDoc(profileDocRef);
          if (profileSnap.exists()) {
            const profileData = profileSnap.data();
            setCurrentUser({ uid, profile: profileData });
            scoresUnsubscribe.current = onSnapshot(scoresColRef, (snap) => {
              setScores(snap.docs.map(d => ({ id: d.id, ...d.data() })));
            });
          } else {
            setCurrentUser({ uid, profile: null });
            setScores([]);
          }
        } catch (e) {
          setCurrentUser({ uid, profile: null });
        }
        setIsAuthReady(true);
        setLoading(false);
      } else {
        try { await signInAnonymously(auth); } catch (e) { setIsAuthReady(true); setLoading(false); }
      }
    });
    return () => { unsubAuth(); if (scoresUnsubscribe.current) scoresUnsubscribe.current(); };
  }, []);

  const handleNavigate = (page) => {
    const hasProfile = currentUser && currentUser.profile && currentUser.profile.name;
    const isSubscribed = currentUser?.profile?.subscriptionStatus === 'active';

    if (['dashboard', 'simulator', 'results'].includes(page)) {
      if (!hasProfile) return setCurrentPage('profile_setup');
      if (!isSubscribed) return setCurrentPage('subscribe');
    }
    setCurrentPage(page);
  };

  const onProfileSetup = async (p) => {
    const finalProfile = { ...p, subscriptionStatus: 'none', createdAt: serverTimestamp() };
    await setDoc(doc(db, 'artifacts', appId, 'users', p.uid, 'profile', 'details'), finalProfile);
    setCurrentUser(prev => ({ ...prev, profile: finalProfile }));
    setCurrentPage('subscribe');
  };

  const onSubscribe = async () => {
    if (!currentUser) return;
    const userDocRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'details');
    await updateDoc(userDocRef, { subscriptionStatus: 'active' });
    setCurrentUser(prev => ({ ...prev, profile: { ...prev.profile, subscriptionStatus: 'active' } }));
    setCurrentPage('dashboard');
  };

  const handleFinishPractice = async (key, correct, total) => {
    const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;
    setLastResults({ scaleKey: key, correctCount: correct, totalCases: total, percentage });
    setCurrentPage('results');
    if (currentUser?.uid) {
      await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'scores'), {
        scaleKey: key, correctCount: correct, totalCases: total, percentage, practicedAt: serverTimestamp()
      });
    }
  };

  const handleLogout = async () => {
    isLoggingOut.current = true;
    if (scoresUnsubscribe.current) { scoresUnsubscribe.current(); scoresUnsubscribe.current = null; }
    await signOut(auth);
    setCurrentUser(null);
    setCurrentPage('home');
    isLoggingOut.current = false;
    try { await signInAnonymously(auth); } catch (e) {}
  };

  return (
    <div className="bg-gray-900 text-gray-100 min-h-screen font-sans selection:bg-copper-500/30">
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .text-glow { text-shadow: 0 0 30px rgba(232,93,4,0.4); }
        .animate-in { animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .bg-copper-600 { background-color: #d05303; }
        .bg-copper-500 { background-color: #e85d04; }
        .border-copper-500 { border-color: #e85d04; }
        .text-copper-500 { color: #e85d04; }
      `}</style>

      <Header onNavigate={handleNavigate} currentUser={currentUser} onLogout={handleLogout} />
      
      <main className="pt-16 pb-12">
        {loading || !isAuthReady ? (
          <div className="flex h-[80vh] items-center justify-center"><Spinner /></div>
        ) : (
          <div className="animate-in">
            {currentPage === 'home' && <HomePage onNavigate={handleNavigate} />}
            {currentPage === 'profile_setup' && <ProfileSetupPage onProfileSetup={onProfileSetup} currentUser={currentUser} />}
            {currentPage === 'subscribe' && <SubscriptionPage onSubscribe={onSubscribe} currentUser={currentUser} />}
            {currentPage === 'dashboard' && <DashboardPage onStartPractice={(k, n) => { setPracticeSettings({ scaleKey: k, totalCases: n }); setCurrentPage('simulator'); }} />}
            {currentPage === 'simulator' && <SimulatorPage {...practiceSettings} onFinishPractice={handleFinishPractice} onNavigate={handleNavigate} />}
            {currentPage === 'results' && <ResultsPage {...lastResults} onNavigate={handleNavigate} />}
            {currentPage === 'profile' && <ProfilePage currentUser={currentUser} scores={scores} />}
          </div>
        )}
      </main>
    </div>
  );
};

// --- Sub-componentes ---

const ProfileSetupPage = ({ onProfileSetup, currentUser }) => {
  const [name, setName] = useState('');
  const [specialty, setSpecialty] = useState('');

  return (
    <div className="pt-24 px-4 flex justify-center pb-20">
      <div className="bg-gray-800 border-2 border-copper-500 p-12 rounded-[3.5rem] shadow-2xl max-w-md w-full relative">
        <div className="absolute -top-8 left-1/2 -translate-x-1/2 w-16 h-16 bg-gray-900 border-2 border-copper-500 rounded-2xl flex items-center justify-center text-3xl">ü•º</div>
        <h2 className="text-3xl font-black text-white mb-2 text-center pt-4 tracking-tight">Registro M√©dico</h2>
        <p className="text-gray-500 text-center mb-10 font-bold uppercase tracking-widest text-[10px]">Identif√≠cate para continuar</p>
        <div className="space-y-8">
            <div>
                <label className="block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-3 text-copper-500">Nombre Completo</label>
                <input value={name} onChange={e => setName(e.target.value)} className="w-full bg-gray-900 border-2 border-gray-700 focus:border-copper-500 rounded-2xl p-5 text-white outline-none transition font-bold" placeholder="Ej: Dr. Garc√≠a" />
            </div>
            <div>
                <label className="block text-[10px] font-black text-gray-500 uppercase tracking-widest mb-3 text-copper-500">Especialidad o Semestre</label>
                <input value={specialty} onChange={e => setSpecialty(e.target.value)} className="w-full bg-gray-900 border-2 border-gray-700 focus:border-copper-500 rounded-2xl p-5 text-white outline-none transition font-bold" placeholder="Ej: R1 Pediatr√≠a" />
            </div>
            <button 
                onClick={() => onProfileSetup({ uid: currentUser.uid, name, specialty })} 
                className="w-full bg-copper-600 border-2 border-copper-500 hover:bg-copper-500 text-white py-5 rounded-2xl font-black text-lg shadow-xl shadow-copper-900/20 uppercase tracking-widest transition"
            >
                Siguiente
            </button>
        </div>
      </div>
    </div>
  );
};

const DashboardPage = ({ onStartPractice }) => {
  const [num, setNum] = useState(10);
  return (
    <div className="max-w-7xl mx-auto px-6 pt-10">
      <div className="mb-16 flex flex-col md:flex-row justify-between items-end gap-10">
        <div>
          <h1 className="text-6xl font-black text-white mb-4 tracking-tighter">Entrenamiento Cl√≠nico</h1>
          <p className="text-gray-400 font-bold text-lg uppercase tracking-widest text-sm">Selecciona una escala para comenzar la simulaci√≥n.</p>
        </div>
        <div className="bg-gray-800/60 p-2 rounded-2xl border-2 border-gray-700 flex gap-2">
          {[5, 10, 25].map(c => (
            <button key={c} onClick={() => setNum(c)} className={`px-10 py-3 rounded-xl font-black text-xs transition-all uppercase tracking-widest ${num === c ? 'bg-copper-600 border-2 border-copper-500 text-white shadow-lg' : 'text-gray-500 hover:text-white border-2 border-transparent'}`}>{c} Casos</button>
          ))}
        </div>
      </div>

      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-10 pb-20">
        {Object.values(scaleData).map(scale => (
          <div key={scale.key} className="group bg-gray-800 border-2 border-gray-800 hover:border-copper-500 p-10 rounded-[3.5rem] transition-all duration-500 shadow-xl flex flex-col items-center text-center">
            <div className="w-16 h-16 bg-gray-900 border-2 border-copper-500 rounded-2xl flex items-center justify-center mb-8 group-hover:scale-110 transition-transform shadow-lg shadow-copper-500/5">
              <Activity className="text-copper-500" size={32} />
            </div>
            <h3 className="text-3xl font-black text-white mb-4 tracking-tight leading-none">{scale.name}</h3>
            <p className="text-gray-500 text-sm font-bold mb-10 leading-relaxed uppercase tracking-wider">Escenarios din√°micos basados en gu√≠as internacionales.</p>
            <button 
                onClick={() => onStartPractice(scale.key, num)} 
                className="w-full bg-copper-600 border-2 border-copper-500 py-4 rounded-2xl font-black uppercase text-xs tracking-[0.2em] shadow-xl shadow-copper-900/40 hover:bg-copper-500 transition-all text-white"
            >
                Entrenar Escala
            </button>
          </div>
        ))}
      </div>
    </div>
  );
};

const SimulatorPage = ({ scaleKey, totalCases, onFinishPractice, onNavigate }) => {
  const [currentIdx, setCurrentIdx] = useState(0);
  const [currentCase, setCurrentCase] = useState(null);
  const [score, setScore] = useState(0);
  const [feedback, setFeedback] = useState(null);
  const scale = scaleData[scaleKey];

  useEffect(() => { setCurrentCase(scale.generateCase()); }, [scale]);

  const handleAnswer = (val) => {
    if (feedback) return;
    const isCorrect = val === currentCase.correctAnswer;
    setFeedback({ isCorrect, selected: val });
    if (isCorrect) setScore(s => s + 1);

    setTimeout(() => {
      setFeedback(null);
      if (currentIdx < totalCases - 1) {
          setCurrentIdx(prev => prev + 1);
          setCurrentCase(scale.generateCase());
      } else {
          onFinishPractice(scaleKey, score + (isCorrect ? 1 : 0), totalCases);
      }
    }, isCorrect ? 1000 : 2500);
  };

  if (!currentCase) return <Spinner />;
  const progress = ((currentIdx + 1) / totalCases) * 100;

  return (
    <div className="max-w-4xl mx-auto px-6 pt-10 pb-20 animate-in">
      <div className="flex justify-between items-center mb-8">
        <h2 className="text-3xl font-black text-white tracking-tighter">{scale.name}</h2>
        <div className="bg-gray-800 border-2 border-copper-500 px-6 py-2 rounded-full text-xs font-black text-copper-500 uppercase tracking-widest">Caso {currentIdx + 1} de {totalCases}</div>
      </div>
      <div className="h-3 bg-gray-800 rounded-full mb-16 overflow-hidden border-2 border-gray-700 shadow-inner">
        <div className="h-full bg-copper-500 transition-all duration-700 shadow-[0_0_25px_rgba(232,93,4,0.6)]" style={{ width: `${progress}%` }}></div>
      </div>
      <div className="bg-gray-800 border-2 border-copper-500 p-12 md:p-16 rounded-[4rem] shadow-2xl relative overflow-hidden backdrop-blur-sm">
        <div className="absolute -top-10 -right-10 p-10 opacity-5 text-9xl select-none text-copper-500">üè•</div>
        <p className="text-white text-3xl md:text-4xl leading-snug font-bold mb-16 tracking-tight">{currentCase.description}</p>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {currentCase.options.map((opt, i) => {
            let style = "bg-gray-900 border-2 border-gray-700 text-white hover:border-copper-500";
            if (feedback) {
              if (opt === currentCase.correctAnswer) style = "bg-green-600 border-2 border-green-400 scale-105 z-10 shadow-2xl shadow-green-500/20";
              else if (feedback.selected === opt) style = "bg-red-600 border-2 border-red-400 opacity-40 grayscale";
              else style = "opacity-20 pointer-events-none";
            }
            return (
              <button key={i} onClick={() => handleAnswer(opt)} disabled={!!feedback} className={`py-7 rounded-[2rem] font-black text-xl transition-all duration-500 flex justify-center items-center shadow-lg ${style}`}>
                {scaleKey === 'wagner' ? `Grado ${opt}` : `${opt} Puntos`}
              </button>
            );
          })}
        </div>
      </div>
    </div>
  );
};

const ResultsPage = ({ scaleKey, correctCount, totalCases, onNavigate }) => {
  const perc = totalCases > 0 ? Math.round((correctCount / totalCases) * 100) : 0;
  return (
    <div className="flex flex-col items-center pt-24 px-6 animate-in">
      <div className="bg-gray-800 border-2 border-copper-500 p-16 rounded-[5rem] shadow-2xl text-center max-w-xl w-full">
        <h1 className="text-8xl font-black text-white mb-6 tracking-tighter">{perc}%</h1>
        <p className="text-gray-400 mb-16 font-bold text-xl uppercase tracking-widest">Resolviste correctamente {correctCount} de {totalCases} casos.</p>
        <div className="grid grid-cols-2 gap-8">
          <button onClick={() => onNavigate('simulator')} className="bg-copper-600 border-2 border-copper-500 text-white font-black py-6 rounded-[2.5rem] hover:bg-copper-500 transition shadow-2xl shadow-copper-900/40 uppercase tracking-widest text-xs">Reiniciar</button>
          <button onClick={() => onNavigate('dashboard')} className="bg-gray-900 border-2 border-gray-700 text-white font-black py-6 rounded-[2.5rem] hover:bg-gray-800 transition uppercase tracking-widest text-xs">Escalas</button>
        </div>
      </div>
    </div>
  );
};

const ProfilePage = ({ currentUser, scores }) => {
    const { name, specialty, subscriptionStatus } = currentUser?.profile || {};
    const totalCases = scores.reduce((a, b) => a + (b.total || 0), 0);
    const correctTotal = scores.reduce((a, b) => a + (b.correctCount || 0), 0);
    const globalAcc = totalCases > 0 ? Math.round((correctTotal / totalCases) * 100) : 0;

    return (
      <div className="max-w-6xl mx-auto px-6 pt-16 animate-in pb-32">
        <div className="flex flex-col md:flex-row items-center gap-12 mb-20 bg-gray-800/40 p-16 rounded-[4rem] border-2 border-gray-800 hover:border-copper-500 transition-colors">
          <div className="w-40 h-40 bg-gray-900 border-2 border-copper-500 rounded-[3rem] flex items-center justify-center text-7xl shadow-2xl select-none text-copper-500">üë§</div>
          <div className="text-center md:text-left flex-1">
            <h1 className="text-6xl font-black text-white mb-2 tracking-tighter">{name}</h1>
            <p className="text-copper-500 font-black text-2xl uppercase tracking-widest mb-6">{specialty}</p>
            <div className={`inline-flex items-center gap-2 px-6 py-2 rounded-full text-[10px] font-black uppercase tracking-widest border-2 ${subscriptionStatus === 'active' ? 'bg-green-500/10 text-green-500 border-green-500/30 shadow-lg shadow-green-500/10' : 'bg-red-500/10 text-red-500 border-red-500/30'}`}>
              {subscriptionStatus === 'active' ? <><Star size={12} fill="currentColor" /> Plan Premium Activo</> : 'Sin Suscripci√≥n'}
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-10 mb-20">
            <div className="bg-gray-800 border-2 border-gray-800 p-10 rounded-[3rem] shadow-xl text-center">
                <span className="block text-gray-500 text-[10px] font-black uppercase tracking-widest mb-4">Precisi√≥n Global</span>
                <span className="text-6xl font-black text-copper-500">{globalAcc}%</span>
            </div>
            <div className="bg-gray-800 border-2 border-gray-800 p-10 rounded-[3rem] shadow-xl text-center">
                <span className="block text-gray-500 text-[10px] font-black uppercase tracking-widest mb-4">Sesiones</span>
                <span className="text-6xl font-black text-white">{scores.length}</span>
            </div>
            <div className="bg-gray-800 border-2 border-gray-800 p-10 rounded-[3rem] shadow-xl text-center">
                <span className="block text-gray-500 text-[10px] font-black uppercase tracking-widest mb-4">Casos Resueltos</span>
                <span className="text-6xl font-black text-white">{totalCases}</span>
            </div>
        </div>

        <h3 className="text-3xl font-black mb-10 tracking-tight text-white">Historial Acad√©mico</h3>
        <div className="space-y-6">
          {scores.length > 0 ? scores.slice().reverse().map((s, i) => (
            <div key={i} className="bg-gray-800/40 border-2 border-gray-800 p-8 rounded-[2.5rem] flex justify-between items-center group hover:border-copper-500 transition-all shadow-xl">
              <div>
                <span className="font-black text-white text-2xl group-hover:text-copper-500 transition-colors">{scaleData[s.scaleKey]?.name || 'Escala M√©dica'}</span>
                <p className="text-xs text-gray-500 font-bold uppercase tracking-widest mt-1">{s.correctCount}/{s.totalCases} ACERTADOS</p>
              </div>
              <div className="flex flex-col items-end">
                <span className="text-4xl font-black text-white">{(s.percentage || 0)}%</span>
                <span className="text-[10px] text-gray-600 font-bold uppercase tracking-widest">Score</span>
              </div>
            </div>
          )) : <p className="text-gray-600 font-bold italic text-center py-20 uppercase tracking-[0.3em]">No hay registros de entrenamiento.</p>}
        </div>
      </div>
    );
};

export default App;
