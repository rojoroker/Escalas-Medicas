<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediScales - Entrenamiento Clínico Profesional</title>
    <!-- Cargamos Tailwind, React y Lucide desde la red (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        copper: {
                            500: '#e85d04',
                            600: '#d05303',
                        },
                        petrol: {
                            500: '#0077b6',
                            600: '#006aa3',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #111827; margin: 0; color: #f3f4f6; font-family: 'Inter', sans-serif; }
        .text-glow { text-shadow: 0 0 20px rgba(232,93,4,0.3); }
        .animate-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 8px; background-color: #111827; }
        ::-webkit-scrollbar-thumb { background-color: #374151; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- SDK de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURACIÓN DE FIREBASE ---
        // REEMPLAZA ESTOS DATOS CON LOS DE TU CONSOLA DE FIREBASE
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_PROYECTO.firebaseapp.com",
            projectId: "TU_PROYECTO_ID",
            storageBucket: "TU_PROYECTO.appspot.com",
            messagingSenderId: "TU_SENDER_ID",
            appId: "TU_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Exportar a window para que React los vea
        window.fb = { auth, db, doc, getDoc, setDoc, collection, addDoc, onSnapshot, serverTimestamp, updateDoc, onAuthStateChanged, signInAnonymously, signOut };
    </script>

    <!-- Código de la Aplicación (Babel se encarga de que el navegador entienda React) -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { Activity, CreditCard, CheckCircle, Star, LogOut, ChevronRight, User: UserIcon, ShieldCheck, Zap, ArrowRight } = lucide;

        // --- Lógica de Generación de Casos ---
        const getRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const getRandomAge = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const getRandomGender = () => Math.random() > 0.5 ? { g: "Un hombre", p: "El paciente", s: "masculino" } : { g: "Una mujer", p: "La paciente", s: "femenino" };

        const introPhrasesAdult = [
            (g, s, a) => `Acude a tu consulta ${s === 'masculino' ? 'un paciente' : 'una paciente'} de ${a} años...`,
            (g, s, a) => `Llega al servicio de urgencias ${g.toLowerCase()} de ${a} años...`,
            (g, s, a) => `Se valora ${s === 'masculino' ? 'a un paciente' : 'a una paciente'} de ${a} años en medicina interna...`,
            (g, s, a) => `Se solicita tu valoración para ${s === 'masculino' ? 'un paciente' : 'una paciente'} de ${a} años...`
        ];

        const scaleData = {
            glasgow: { 
                name: "Escala de Glasgow", 
                key: "glasgow", 
                generateCase: () => {
                    const eye = [{ s: 4, n: "ojos espontáneos" }, { s: 1, n: "sin apertura ocular" }];
                    const verbal = [{ s: 5, n: "orientado" }, { s: 2, n: "sonidos incomprensibles" }];
                    const motor = [{ s: 6, n: "obedece órdenes" }, { s: 4, n: "retirada al dolor" }];
                    const e = getRandom(eye); const v = getRandom(verbal); const m = getRandom(motor);
                    const total = e.s + v.s + m.s;
                    const { g, s } = getRandomGender();
                    const intro = getRandom(introPhrasesAdult)(g, s, getRandomAge(18, 80));
                    return { description: `${intro} Tras un trauma, presenta ${e.n}, está ${v.n} y muestra ${m.n}.`, options: [total, total-3, total+2, 15].sort((a,b)=>a-b), correctAnswer: total };
                }
            },
            wagner: {
                name: "Escala de Wagner",
                key: "wagner",
                generateCase: () => {
                    const grades = [
                        { s: 0, n: "pie en riesgo, callosidades pero piel íntegra." },
                        { s: 1, n: "úlcera superficial en la dermis." },
                        { s: 2, n: "úlcera profunda que llega a tendones." },
                        { s: 3, n: "úlcera profunda con absceso u osteomielitis." },
                        { s: 4, n: "gangrena localizada." },
                        { s: 5, n: "gangrena extensa de todo el pie." }
                    ];
                    const item = getRandom(grades);
                    const { g, s } = getRandomGender();
                    const intro = getRandom(introPhrasesAdult)(g, s, getRandomAge(50, 80));
                    return { description: `${intro} Diabético. A la inspección: ${item.n}`, options: [0, 1, 2, 3, 4, 5].sort(()=>Math.random()-0.5).slice(0,4).sort(), correctAnswer: item.s };
                }
            },
            apgar: { name: "Puntuación de Apgar", key: "apgar", generateCase: () => ({ description: "Recién nacido a los 5 min: cuerpo rosado, manos cianóticas, FC 110, llanto fuerte y gesticula activo.", options: [7, 8, 9, 10], correctAnswer: 9 })},
            silverman: { name: "Escala de Silverman", key: "silverman", generateCase: () => ({ description: "Neonato con aleteo nasal marcado, quejido audible y tiraje intercostal evidente.", options: [3, 5, 7, 9], correctAnswer: 7 })},
            alvarado: { name: "Escala de Alvarado", key: "alvarado", generateCase: () => ({ description: "Paciente con dolor migratorio a FID, náuseas, fiebre y leucocitosis.", options: [5, 6, 7, 8], correctAnswer: 7 })},
            wells: { name: "Criterios de Wells", key: "wells", generateCase: () => ({ description: "Paciente con cáncer activo, edema de pierna y dolor venoso profundo.", options: [1, 2, 3, 4], correctAnswer: 3 })},
            curb65: { name: "Escala CURB-65", key: "curb65", generateCase: () => ({ description: "Paciente de 75 años, confuso, FR 32, Urea 50 mg/dL.", options: [3, 4, 5, 6], correctAnswer: 5 })}
        };

        // --- Componentes ---

        const Icon = ({ name, size = 20, className = "" }) => {
            const LucideIcon = lucide[name];
            return LucideIcon ? <LucideIcon size={size} className={className} /> : null;
        };

        const Header = ({ onNavigate, user, onLogout }) => {
            const isSubscribed = user?.profile?.subscriptionStatus === 'active';
            return (
                <nav className="bg-gray-900 border-b border-gray-800 h-16 flex items-center justify-between px-6 fixed w-full top-0 z-50 shadow-md">
                    <div className="flex items-center space-x-3 cursor-pointer" onClick={() => onNavigate('home')}>
                        <div className="w-10 h-10 bg-gray-800 border-2 border-copper-500 rounded-xl flex items-center justify-center font-black text-copper-500">M</div>
                        <span className="text-xl font-black">Medi<span className="text-copper-500">Scales</span></span>
                    </div>
                    {user?.profile && (
                        <div className="flex items-center space-x-6">
                            {isSubscribed && <span className="bg-copper-500/10 text-copper-500 px-3 py-1 rounded-full text-[10px] font-black border border-copper-500/30 uppercase">Premium</span>}
                            <button onClick={() => onNavigate('dashboard')} className="text-gray-400 font-bold text-xs uppercase hover:text-copper-500">Escalas</button>
                            <button onClick={onLogout} className="text-red-500"><Icon name="LogOut" /></button>
                        </div>
                    )}
                </nav>
            );
        };

        const HomePage = ({ onNavigate }) => (
            <div className="pt-32 text-center px-6 animate-in">
                <div className="inline-block p-4 border-2 border-copper-500 rounded-3xl mb-8 bg-copper-500/5">
                    <Icon name="Activity" size={40} className="text-copper-500" />
                </div>
                <h1 className="text-6xl font-black mb-6">Decisiones Médicas <br/><span className="text-copper-500">Sin Errores</span></h1>
                <p className="text-gray-400 text-xl mb-12 max-w-2xl mx-auto font-medium">Entrena tu ojo clínico con nuestro simulador avanzado de escalas.</p>
                <button onClick={() => onNavigate('dashboard')} className="bg-copper-600 border-2 border-copper-500 px-12 py-5 rounded-2xl font-black text-xl text-white hover:bg-copper-500 transition-all shadow-2xl shadow-copper-900/40">COMENZAR AHORA</button>
            </div>
        );

        const ProfileSetup = ({ onSetup, user }) => {
            const [n, setN] = useState('');
            const [s, setS] = useState('');
            return (
                <div className="pt-32 flex justify-center px-6 animate-in">
                    <div className="bg-gray-800 border-2 border-copper-500 p-10 rounded-[3rem] w-full max-w-md shadow-2xl">
                        <h2 className="text-3xl font-black mb-6 text-center">Registro Médico</h2>
                        <input placeholder="Nombre Completo" className="w-full bg-gray-900 border-2 border-gray-700 focus:border-copper-500 p-5 rounded-2xl mb-4 text-white outline-none font-bold" onChange={e => setN(e.target.value)} />
                        <input placeholder="Especialidad / Nivel" className="w-full bg-gray-900 border-2 border-gray-700 focus:border-copper-500 p-5 rounded-2xl mb-8 text-white outline-none font-bold" onChange={e => setS(e.target.value)} />
                        <button onClick={() => onSetup({ name: n, specialty: s, uid: user.uid })} className="w-full bg-copper-600 border-2 border-copper-500 py-5 rounded-2xl font-black text-lg">SIGUIENTE</button>
                    </div>
                </div>
            );
        };

        const Subscription = ({ onSub }) => (
            <div className="pt-32 flex flex-col items-center px-6 animate-in">
                <div className="bg-gray-800 border-2 border-copper-500 p-12 rounded-[4rem] max-w-md w-full shadow-2xl text-center relative overflow-hidden">
                    <div className="absolute top-0 right-0 bg-copper-500 text-white px-6 py-2 font-black text-[10px] uppercase">Plan Premium</div>
                    <h2 className="text-2xl font-black mb-2 uppercase tracking-tighter">Acceso Ilimitado</h2>
                    <div className="flex justify-center items-baseline gap-2 mb-10">
                        <span className="text-6xl font-black">$99</span>
                        <span className="text-gray-400 font-bold uppercase">MXN / Mes</span>
                    </div>
                    <div className="space-y-4 mb-10 text-left">
                        <div className="flex items-center gap-3 font-bold"><Icon name="CheckCircle" className="text-copper-500"/> 7 Escalas Médicas</div>
                        <div className="flex items-center gap-3 font-bold"><Icon name="CheckCircle" className="text-copper-500"/> Casos Clínicos Infinitos</div>
                    </div>
                    <button onClick={onSub} className="w-full bg-copper-600 border-2 border-copper-500 py-5 rounded-2xl font-black text-lg shadow-xl shadow-copper-900/40 hover:bg-copper-500 transition-all uppercase tracking-widest">Activar Suscripción</button>
                </div>
            </div>
        );

        const Dashboard = ({ onStart }) => (
            <div className="pt-24 px-8 max-w-6xl mx-auto pb-20 animate-in">
                <h1 className="text-5xl font-black mb-12 tracking-tighter">Entrenamiento</h1>
                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                    {Object.keys(scaleData).map(k => (
                        <div key={k} className="bg-gray-800 border-2 border-gray-800 hover:border-copper-500 p-10 rounded-[3rem] transition-all shadow-xl text-center flex flex-col items-center group">
                            <div className="w-14 h-14 bg-gray-900 border-2 border-copper-500 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                                <Icon name="Activity" className="text-copper-500" />
                            </div>
                            <h3 className="text-2xl font-black mb-4">{scaleData[k].name}</h3>
                            <button onClick={() => onStart(k)} className="w-full bg-copper-600 border-2 border-copper-500 py-4 rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-copper-500 transition-all">Entrenar Escala</button>
                        </div>
                    ))}
                </div>
            </div>
        );

        const Simulator = ({ scaleKey, onFinish }) => {
            const [caseD, setCaseD] = useState(null);
            const [feedback, setFeedback] = useState(null);
            const [idx, setIdx] = useState(0);
            const [score, setScore] = useState(0);
            const total = 5;

            useEffect(() => setCaseD(scaleData[scaleKey].generateCase()), [scaleKey]);

            const solve = (v) => {
                if(feedback) return;
                const isC = v === caseD.correctAnswer;
                setFeedback({ isC, v });
                if(isC) setScore(s => s + 1);
                setTimeout(() => {
                    if(idx < total - 1) { setIdx(i => i + 1); setCaseD(scaleData[scaleKey].generateCase()); setFeedback(null); }
                    else onFinish(score + (isC ? 1 : 0), total);
                }, 1500);
            };

            if(!caseD) return <div className="pt-40 text-center">Cargando escenario...</div>;

            return (
                <div className="pt-24 px-6 max-w-4xl mx-auto animate-in">
                    <div className="bg-gray-800 border-2 border-copper-500 p-12 rounded-[4rem] shadow-2xl relative overflow-hidden">
                        <span className="text-xs font-black text-copper-500 uppercase tracking-widest mb-6 block">Caso {idx+1} de {total}</span>
                        <p className="text-2xl md:text-3xl font-bold mb-12">{caseD.description}</p>
                        <div className="grid grid-cols-2 gap-4">
                            {caseD.options.map(o => (
                                <button key={o} onClick={() => solve(o)} className={`py-6 rounded-2xl border-2 font-black text-xl transition-all ${feedback?.v === o ? (feedback.isC ? 'bg-green-600 border-green-400 shadow-green-500/20' : 'bg-red-600 border-red-400 opacity-50') : 'bg-gray-900 border-gray-700 hover:border-copper-500'}`}>
                                    {scaleKey === 'wagner' ? `Grado ${o}` : `${o} Pts`}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [page, setPage] = useState('home');
            const [user, setUser] = useState(null);
            const [activeK, setActiveK] = useState(null);
            const [res, setRes] = useState(null);

            useEffect(() => {
                const unsub = fb.onAuthStateChanged(fb.auth, async (u) => {
                    if(u) {
                        const snap = await fb.getDoc(fb.doc(fb.db, 'artifacts', 'med-pro', 'users', u.uid, 'profile', 'details'));
                        setUser({ uid: u.uid, profile: snap.exists() ? snap.data() : null });
                    } else fb.signInAnonymously(fb.auth);
                });
                return unsub;
            }, []);

            const navigate = (p) => {
                const hasP = user?.profile?.name;
                const isS = user?.profile?.subscriptionStatus === 'active';
                if(['dashboard', 'simulator'].includes(p)) {
                    if(!hasP) return setPage('profile_setup');
                    if(!isS) return setPage('subscribe');
                }
                setPage(p);
            };

            const onSetup = async (p) => {
                const data = { ...p, subscriptionStatus: 'none', createdAt: fb.serverTimestamp() };
                await fb.setDoc(fb.doc(fb.db, 'artifacts', 'med-pro', 'users', p.uid, 'profile', 'details'), data);
                setUser(prev => ({ ...prev, profile: data }));
                setPage('subscribe');
            };

            const onSub = async () => {
                await fb.updateDoc(fb.doc(fb.db, 'artifacts', 'med-pro', 'users', user.uid, 'profile', 'details'), { subscriptionStatus: 'active' });
                setUser(p => ({ ...p, profile: { ...p.profile, subscriptionStatus: 'active' }}));
                setPage('dashboard');
            };

            return (
                <div className="min-h-screen">
                    <Header onNavigate={navigate} user={user} onLogout={() => fb.signOut(fb.auth).then(() => window.location.reload())} />
                    {page === 'home' && <HomePage onNavigate={navigate} />}
                    {page === 'profile_setup' && <ProfileSetup onSetup={onSetup} user={user} />}
                    {page === 'subscribe' && <Subscription onSub={onSub} />}
                    {page === 'dashboard' && <Dashboard onStart={(k) => { setActiveK(k); setPage('simulator'); }} />}
                    {page === 'simulator' && <Simulator scaleKey={activeK} onFinish={(s, t) => { setRes({s, t}); setPage('results'); }} />}
                    {page === 'results' && (
                        <div className="pt-40 text-center animate-in">
                            <h1 className="text-8xl font-black mb-6">{Math.round((res.s/res.t)*100)}%</h1>
                            <p className="text-xl text-gray-500 font-bold mb-12">Acertaste {res.s} de {res.t} casos.</p>
                            <button onClick={() => setPage('dashboard')} className="bg-copper-600 border-2 border-copper-500 px-10 py-4 rounded-2xl font-black uppercase tracking-widest shadow-xl">Volver al Panel</button>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
